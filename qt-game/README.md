# 迷宫探险游戏 (Maze Adventure Game)

一个使用Qt开发的迷宫探险游戏，具有多种迷宫生成方式和智能陷阱系统。

## 项目结构

```
qt-game/
├── CMakeLists.txt          # CMake构建配置文件
├── README.md              # 项目说明文档
├── example_maze.txt       # 迷宫设计示例
├── build/                 # 构建输出目录
│   └── qt-game           # 可执行文件
├── include/               # 头文件目录
│   ├── advancedimageprocessor.h
│   ├── fog.h
│   ├── game.h
│   ├── imageprocessor.h
│   ├── mainwindow.h
│   ├── mainwindow.ui
│   ├── map.h
│   ├── player.h
│   ├── solver.h
│   └── trap.h
└── src/                   # 源文件目录
    ├── advancedimageprocessor.cpp
    ├── fog.cpp
    ├── game.cpp
    ├── imageprocessor.cpp
    ├── main.cpp
    ├── mainwindow.cpp
    ├── map.cpp
    ├── player.cpp
    ├── solver.cpp
    └── trap.cpp
```

## 游戏特性

### 🎮 核心玩法
- **玩家控制**：使用WASD键控制角色移动
- **血量系统**：玩家有100点血量，踩到陷阱会扣血
- **胜利条件**：到达绿色终点方块
- **游戏结束**：血量耗尽或成功通关

### 🗺️ 地图系统
- **多种地图**：
  - 地图1：经典递归迷宫（DFS设计）
  - 地图2：螺旋迷宫
  - 随机地图：DFS算法生成完美迷宫（每次重置自动刷新）
  - 图片导入：支持黑白图片生成迷宫
  - 图片地图：从二值化图片生成
- **视觉效果**：
  - 墙壁：灰色方块
  - 通路：白色方块
  - 起点：蓝色方块
  - 终点：绿色方块

### 🌫️ 迷雾系统
- **迷雾模式**：地图初始为未知状态
- **视野范围**：玩家周围5x5方形区域可见（上下左右各2个方块）
- **探索机制**：已探索区域保持可见，重置时迷雾模式状态保持不变
- **视觉效果**：
  - 未知区域：黑色
  - 已探索区域：半透明黑色
  - 当前视野：完全透明
- **视野形状**：清晰的方形边界，便于玩家判断探索范围

### ⚡ 自动寻路
- **A*算法**：智能路径规划
- **避障能力**：避开墙壁和陷阱
- **实时更新**：从当前位置重新计算路径
- **一键操作**：点击按钮开始/停止自动寻路

### 🕳️ 陷阱系统
- **动态生成**：每3秒随机生成一个陷阱
- **智能消失**：
  - 玩家触发的陷阱：永久消失
  - 自动消失的陷阱：5秒后重新生成
- **安全机制**：不会生成在玩家脚下
- **视觉反馈**：触发时显示红色（0.5秒）

### 🖼️ 图片迷宫生成
- **二值化处理**：支持多种二值化算法
- **智能识别**：自动识别起点和终点
- **格式支持**：PNG、JPG、JPEG、BMP、GIF等
- **缩放适配**：自动缩放到20x20网格

## 技术特性

### 🎯 算法实现
- **A*寻路算法**：智能路径规划
- **大津法二值化**：图像处理算法
- **自适应阈值**：动态阈值计算
- **邻居像素分析**：起点终点智能识别

### 🔧 架构设计
- **模块化设计**：清晰的类职责划分
- **事件驱动**：基于Qt信号槽机制
- **内存管理**：自动资源清理
- **错误处理**：完善的异常处理机制

### 🎨 用户界面
- **现代设计**：清晰的视觉反馈
- **多语言支持**：中英文界面
- **响应式布局**：适配不同屏幕尺寸
- **直观操作**：简单明了的控制界面

## 快速开始 🚀

### 推荐方式：VSCode DevContainer（一键启动）

这是最简单的方式，无需手动安装任何依赖！

#### 前置要求
1. **Docker Desktop** - 确保已安装并运行
2. **Visual Studio Code** - 安装 "Dev Containers" 扩展
3. **X11 服务器** (用于显示图形界面)
   - Linux: 系统自带，无需额外配置
   - macOS: 安装 [XQuartz](https://www.xquartz.org/)
   - Windows: 安装 [VcXsrv](https://sourceforge.net/projects/vcxsrv/) 或 X410

#### 使用步骤
```bash
# 1. 克隆项目
git clone <你的仓库地址>
cd qt-game

# 2. 在 VSCode 中打开项目
code .

# 3. 在容器中重新打开项目
# 方法一：当 VSCode 打开时，会自动提示"在容器中重新打开"，点击即可
# 方法二：按 Ctrl+Shift+P，选择 "Dev Containers: Reopen in Container"

# 4. 等待自动完成（首次约需 5-10 分钟）
#    - 下载 Qt6 开发镜像
#    - 容器启动并自动编译项目
#    - 完成！可以开始开发和游戏

# 5. 开始使用
# - 按 F5 开始调试
# - 或运行 ./run.sh 启动游戏
```

#### 工作原理
1. VSCode 从 Docker Hub 下载 `stateoftheartio/qt6:6.6-gcc-aqt` 镜像
2. 创建并启动开发容器
3. 自动安装系统依赖（OpenGL、X11、中文字体等）
4. 配置字体支持（解决中文显示方框问题）
5. 自动清理旧的构建缓存
6. 自动编译你的迷宫游戏项目
7. 完成！环境已准备就绪

#### 优势
- ✅ **零配置**：无需手动安装 Qt6 或任何依赖
- ✅ **环境隔离**：不影响宿主机环境
- ✅ **一致性**：所有开发者使用相同的环境
- ✅ **即时调试**：内置 GDB 调试支持
- ✅ **跨平台**：支持 Linux、macOS、Windows

---

### 方法二：本地环境构建

如果你已经安装了 Qt6 开发环境，可以直接在本地构建。

#### 环境要求
- Qt 6.6.1 或更高版本
- CMake 3.16 或更高版本
- C++17 编译器

#### 构建步骤
```bash
# 进入项目目录
cd qt-game

# 使用编译脚本（推荐）
./build.sh

# 或手动构建
mkdir build && cd build
cmake ..
make -j$(nproc)

# 运行游戏
./run.sh
```

### 核心脚本
项目包含以下核心脚本：
- `build.sh`：智能编译脚本（支持本地和容器环境）
- `run.sh`：智能运行脚本（支持调试模式）
- `.devcontainer/postCreateCommand.sh`：DevContainer自动初始化脚本

### 🔧 故障排除

#### 地图选择崩溃问题

**问题症状**：在开始菜单中点击地图选项程序崩溃

**原因分析**：
- 地图选择时立即绘制地图到场景，导致界面未准备好时就开始图形操作
- 游戏状态管理混乱，MENU状态下就开始游戏逻辑
- 地图对象生命周期管理不当

**修复方案**：
1. **延迟地图绘制**：地图选择时只生成数据，不立即绘制
2. **游戏启动时验证**：开始游戏前确保地图已正确生成
3. **状态管理优化**：清晰分离菜单选择和游戏进行两个阶段
4. **资源管理改进**：正确处理地图对象的创建和销毁

**修复后的地图选择流程**：
1. 点击地图按钮 → 生成地图数据，更新按钮样式
2. 开始按钮启用 → 地图预览完成
3. 点击开始游戏 → 绘制地图到场景，开始游戏逻辑
4. 游戏中重置 → 根据地图类型决定是否重新生成地图

**验证方法**：
```bash
./test_map_selection.sh
```

#### 随机地图生成崩溃问题

**问题症状**：点击随机地图按钮时游戏崩溃

**原因分析**：
- DFS算法生成的迷宫经常无法保证起点到终点的连通性
- `generateRandomMap()`函数在验证失败时无限递归调用自身
- 递归调用次数过多导致栈溢出和程序崩溃

**修复方案**：
1. **移除无限递归**：不再在验证失败时重新调用`generateRandomMap()`
2. **添加备用路径**：实现`createSimplePath()`函数创建简单连通路径
3. **保证连通性**：确保起点和终点始终可达
4. **稳定性提升**：避免栈溢出，保证程序稳定运行

**修复后的生成流程**：
1. DFS生成随机迷宫 → 创建复杂路径结构
2. 设置起点和终点 → (1,1) 和 (18,18)
3. 检查可达性 → 验证起点到终点是否连通
4. 如果不可达 → 创建简单L形路径连接
5. 放置随机陷阱 → 在路径上安全放置陷阱
6. 完成生成 → 返回可用的迷宫地图

**验证方法**：
```bash
./test_random_map_fix.sh
```

#### 地图预览显示问题

**问题症状**：地图进入后不需要重置就有地图出现

**原因分析**：
- 地图选择时只生成数据，不立即绘制到场景
- 开始游戏时才绘制地图，导致预览延迟
- 用户无法在选择地图时看到地图预览

**修复方案**：
1. **立即绘制预览**：地图选择时立即调用`drawMap()`绘制地图
2. **避免重复绘制**：开始游戏时不再重复绘制地图
3. **提升用户体验**：用户选择地图后立即看到预览
4. **优化响应速度**：减少地图显示延迟

**修复后的显示流程**：
1. 选择地图 → 立即生成并绘制地图预览
2. 开始按钮启用 → 地图已在界面中显示
3. 点击开始游戏 → 初始化玩家和游戏逻辑
4. 游戏开始 → 玩家出现在起点，地图完整显示

**验证方法**：
```bash
./test_map_preview_fix.sh
```

#### 编译和运行问题

**问题症状**：无法在VSCode DevContainer中编译项目

**原因分析**：
- DevContainer配置缺少工作区挂载
- 容器内目录结构与本地不一致
- Qt6路径配置问题

**修复方案**：
1. **修复DevContainer配置**：添加工作区挂载和正确的路径设置
2. **通用编译脚本**：`build.sh`自动检测环境并配置Qt6路径
3. **环境设置脚本**：`setup.sh`自动安装依赖和配置环境
4. **VSCode集成**：完整的调试和构建配置

**使用方法**：
```bash
# 在任何环境中编译
./build.sh

# 在任何环境中运行
./run.sh

# 设置开发环境（DevContainer会自动完成）
```

**验证方法**：
- 容器环境：在VSCode DevContainer中重新打开项目
- 容器启动后自动安装依赖和配置字体

#### 中文显示方框问题

**问题症状**：游戏界面中的中文文字显示为方框或乱码

**原因分析**：
- 容器中缺少中文字体支持
- 字体缓存未正确配置
- Qt无法找到合适的中文字体

**解决方案**：
1. **自动修复**：容器启动时会自动安装中文字体并更新字体缓存
2. **已安装字体**：
   - fontconfig (字体配置工具)
   - fonts-noto-cjk (Google Noto CJK 中文字体)
   - fonts-noto-cjk-extra (Noto CJK 扩展字体)
   - 文泉驿字体（系统自带）
3. **字体配置**：自动更新字体缓存，确保中文正确显示

**验证方法**：
容器启动后，中文界面应该正常显示。如果仍有问题，请检查：
```bash
# 查看已安装的中文字体
fc-list :lang=zh-cn

# 检查字体缓存
fc-cache -v
```

#### DevContainer 启动失败问题

**问题症状**：容器启动时显示 "postCreateCommand from devcontainer.json failed with exit code 127"

**原因分析**：
- 脚本语法错误或命令不存在
- 依赖包名称不正确或不存在
- 权限问题导致命令执行失败

**解决方案**：
1. **自动修复**：脚本已优化，支持有无sudo权限的情况
2. **依赖精简**：只安装最核心的依赖包，避免不存在的包
3. **错误处理**：即使部分依赖安装失败，也会继续构建

**验证方法**：
```bash
# 检查脚本语法
bash -n .devcontainer/postCreateCommand.sh

# 检查关键命令
command -v apt-get && command -v fc-cache && command -v cmake
```

---

#### DevContainer CMake缓存问题

**问题症状**：容器启动时CMake缓存路径不匹配错误

**原因分析**：
- DevContainer工作目录是`/workspace`，本地目录不同
- CMake缓存文件包含绝对路径，导致路径冲突
- 容器启动时使用了旧的CMake缓存

**修复方案**：
1. **修复postCreateCommand**：清理缓存后重新配置CMake
2. **添加初始化脚本**：`.devcontainer/postCreateCommand.sh`
3. **创建修复脚本**：`fix_devcontainer.sh`手动修复
4. **添加.gitignore**：排除构建文件避免冲突

**使用方法**：
```bash
# 重新构建容器（推荐）
# Ctrl+Shift+P -> Dev Containers: Rebuild Container

# 手动修复
./fix_devcontainer.sh --build
```

**详细说明**：查看`DEVCONTAINER_FIX_README.md`

#### DevContainer OpenGL依赖问题

**问题症状**：容器启动时Qt6找不到OpenGL依赖

**原因分析**：
- DevContainer镜像缺少OpenGL开发库
- Qt6需要OpenGL支持才能正常工作
- 容器环境中没有安装必要的图形库依赖

**修复方案**：
1. **自定义Dockerfile**：基于Qt6镜像安装OpenGL依赖
2. **更新DevContainer配置**：设置正确的环境变量和路径
3. **创建修复脚本**：`fix_opengl_deps.sh`手动修复
4. **更新CMake配置**：设置正确的Qt6路径

**使用方法**：
```bash
# 重新构建容器（推荐）
# Ctrl+Shift+P -> Dev Containers: Rebuild Container

# 手动修复
./fix_opengl_deps.sh --build
```

**详细说明**：查看`OPENGGL_FIX_README.md`

#### DevContainer权限问题

**问题症状**：容器构建时权限不足错误

**原因分析**：
- Dockerfile构建时权限不足
- 非root用户无法执行apt-get操作
- 容器构建过程中的权限问题

**修复方案**：
1. **使用预构建镜像**：移除自定义Dockerfile，使用预构建Qt6镜像
2. **修复postCreateCommand**：在容器启动后安装依赖
3. **创建权限修复脚本**：`fix_container_permissions.sh`手动修复
4. **清理Docker缓存**：避免使用旧缓存

**使用方法**：
```bash
# 清理Docker缓存
docker system prune -f

# 重新构建容器（推荐）
# Ctrl+Shift+P -> Dev Containers: Rebuild Container

# 手动修复
./fix_container_permissions.sh --clean
```

**详细说明**：查看`CONTAINER_PERMISSIONS_FIX_README.md`

#### DevContainer sudo权限问题

**问题症状**：容器内用户没有sudo权限，无法执行apt-get

**原因分析**：
- 容器内用户没有sudo权限
- apt-get需要root权限才能执行
- DevContainer默认用户权限受限

**修复方案**：
1. **智能权限检测**：创建`setup-deps.sh`脚本自动检测权限
2. **权限降级处理**：没有sudo时尝试直接使用apt-get
3. **创建修复脚本**：`fix_container_sudo.sh`手动修复
4. **更新postCreateCommand**：使用智能安装脚本

**使用方法**：
```bash
# 重新构建容器（推荐）
# Ctrl+Shift+P -> Dev Containers: Rebuild Container

# 手动修复
./fix_container_sudo.sh --install
```

**详细说明**：查看`CONTAINER_SUDO_FIX_README.md`

#### VSCode运行问题

**问题症状**：VSCode无法编译、运行或调试项目

**原因分析**：
- CMake缓存路径冲突
- VSCode配置错误
- 无关脚本干扰

**修复方案**：
1. **清理构建目录**：`rm -rf build`
2. **重新编译**：`./build.sh`
3. **修复VSCode配置**：移除错误的visualizerFile
4. **删除无关脚本**：清理修复脚本

**使用方法**：
```bash
# 编译项目
./build.sh

# 运行项目
./run.sh

# VSCode调试
# 按F5开始调试
```

#### 跨环境编译问题

**问题症状**：容器和本地环境CMake缓存路径冲突，无法正常编译

**原因分析**：
- DevContainer工作目录是`/workspace`
- 本地工作目录不同
- CMake缓存文件包含绝对路径
- 容器和本地环境切换时使用旧缓存

**修复方案**：
1. **智能缓存检测**：build.sh自动检测CMake缓存路径
2. **自动清理机制**：路径不一致时自动清理缓存
3. **统一编译流程**：使用build.sh脚本统一编译
4. **DevContainer配置**：容器启动时清理缓存

**使用方法**：
```bash
# 本地环境编译
./build.sh

# 容器环境编译
# Ctrl+Shift+P -> Dev Containers: Rebuild Container

# 手动清理缓存
./clean_build.sh --build
```

**详细说明**：查看`CROSS_ENVIRONMENT_BUILD.md`

#### 其他常见问题

- **编译错误**：运行`./setup.sh --check`检查环境
- **运行时错误**：运行`./run.sh --debug`调试运行
- **性能问题**：迷雾模式下关闭不必要的图形效果
- **详细指南**：查看`README_BUILD.md`获取完整说明

## 使用说明

### 基本操作
1. **启动游戏**：运行程序后进入主菜单（无地图显示）
2. **选择地图**：点击地图按钮选择游戏地图，地图将显示在界面中
3. **开始游戏**：点击"开始游戏"按钮进入游戏界面，游戏正式开始
4. **控制角色**：使用WASD键移动
5. **避开陷阱**：红色方块是陷阱，踩到会扣血
6. **到达终点**：绿色方块是终点，到达即可通关
7. **重新开始**：游戏结束后可选择新地图重新开始

### 高级功能
1. **迷雾模式**：启用后只能看到周围区域（5x5方形视野）
2. **自动寻路**：A*算法自动规划最短路径
3. **图片迷宫**：从黑白图片生成自定义迷宫
4. **随机迷宫**：DFS算法生成完美迷宫（每次重置自动刷新）
5. **智能陷阱**：随机放置但避开起点终点附近区域

## 项目特色

### 🎮 游戏体验
- **多样化玩法**：多种地图类型和游戏模式
- **智能AI**：自动寻路和智能陷阱系统
- **视觉效果**：迷雾和陷阱的视觉反馈
- **用户友好**：直观的界面和操作

### 🛠️ 技术亮点
- **模块化架构**：清晰的代码组织
- **算法丰富**：多种经典算法实现
- **图像处理**：先进的二值化技术
- **跨平台支持**：基于Qt的跨平台特性

这是一个功能完整、架构清晰的迷宫游戏项目，展示了C++编程、Qt框架使用、算法实现和图像处理等多方面的技术能力。